<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Itens e Regras</title>
<style>
  :root{
    --bg:#0f1115;
    --card:#171a21;
    --muted:#a7b0c0;
    --text:#e7ecf5;
    --text-dim:#c7cfda;
    --brand:#e30613;
    --brand-600:#c30612;
    --brand-700:#9e050e;
    --ok:#2ecc71;
    --warn:#f39c12;
    --danger:#ff4757;
    --stroke:#232733;
    --chip:#202534;
    --chip-bd:#2b3142;
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    color:var(--text);
    background: radial-gradient(1000px 600px at 10% -10%, rgba(227,6,19,.12), transparent 55%) ,
                radial-gradient(900px 500px at 110% -20%, rgba(227,6,19,.10), transparent 50%) ,
                var(--bg);
  }
  /* Header */
  .header{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; gap:14px;
    padding:18px 22px; background:rgba(15,17,21,.72);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--stroke);
  }
  .brand-badge{
    width:36px;height:36px; border-radius:10px; background: var(--brand);
    display:grid; place-items:center; box-shadow: inset 0 -6px 12px rgba(0,0,0,.25), var(--shadow);
  }
  .brand-badge span{font-weight:900; color:#fff; letter-spacing:.5px}
  .header h1{font-size:18px; margin:0; font-weight:800; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:13px; margin-left:auto; display:flex; gap:10px; align-items:center}
  .pill{padding:6px 10px; border:1px solid var(--stroke); border-radius:999px; background:#0d0f14; color:var(--text-dim)}
  .actions{display:flex; gap:8px; align-items:center}
  .btn, button.icon{
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, #1b1f2a, #131722);
    color:var(--text); border-radius:12px;
    padding:10px 14px; cursor:pointer; transition:.2s transform,.2s border-color,.2s background;
    display:inline-flex; align-items:center; gap:8px; justify-content:center; height:40px;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.brand{background: linear-gradient(180deg, var(--brand), var(--brand-600)); border-color:#00000033}
  .btn.brand:hover{background: linear-gradient(180deg, var(--brand-600), var(--brand-700))}
  .btn.action{min-width:104px} /* BOTÕES MAIS ORGANIZADOS/IGUAIS */
  button.icon svg{opacity:.9}

  /* Toolbar */
  .toolbar{
    display:flex; gap:10px; padding:18px 22px; border-bottom:1px solid var(--stroke);
    background:rgba(0,0,0,.15);
  }
  .search{ position:relative; flex:1; }
  .search input{
    width:100%; padding:12px 14px 12px 40px; background:var(--card); color:var(--text);
    border:1px solid var(--stroke); border-radius:12px;
  }
  .search svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
  .toolbar .right{display:flex; gap:8px}

  /* Main grid */
  .wrap{max-width:1200px; margin:22px auto; padding:0 20px}
  .section-title{display:flex; align-items:center; justify-content:space-between; margin:12px 0 10px}
  .section-title h2{margin:0; font-size:16px; color:#f0f4ff; letter-spacing:.3px}
  .cards{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px}
  .card{
    grid-column: span 12;
    background: linear-gradient(180deg, #161a23, #121622);
    border:1px solid var(--stroke); border-radius:var(--radius); padding:14px; display:flex; gap:14px; align-items:center;
    box-shadow: var(--shadow);
  }
  @media (min-width:740px){ .card{grid-column: span 6} }
  @media (min-width:1024px){ .card{grid-column: span 6} } /* mantém espaçamento estável */
  .thumb{width:72px;height:72px;border-radius:14px;background:#0b0e14;border:1px solid var(--stroke);display:grid;place-items:center;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;object-fit:contain}
  .meta{flex:1; min-width:0}
  .meta .name{font-weight:800; margin:0 0 6px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .meta .desc{color:var(--muted); font-size:13px}
  .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:10px}
  .chip{
    background:var(--chip); border:1px solid var(--chip-bd); color:#cfe0ff; font-size:12px;
    padding:6px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px;
  }
  .chip svg{opacity:.7}
  .switch{display:flex; gap:8px; align-items:center}
  .switch input{appearance:none; width:44px; height:26px; border-radius:999px; position:relative; background:#2b3244; transition:.2s; outline:none; cursor:pointer}
  .switch input:checked{background:linear-gradient(180deg, var(--brand), var(--brand-600))}
  .switch input::after{content:''; position:absolute; top:3px; left:3px; width:20px;height:20px; background:#fff; border-radius:10px; transition:.2s}
  .switch input:checked::after{left:21px}

  /* BOTÕES ALINHADOS/ORGANIZADOS */
  .card .right{
    margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .card .btns{display:flex; gap:8px; flex-wrap:wrap}

  /* Empty state */
  .empty{
    border:1px dashed var(--stroke); background:linear-gradient(180deg, #121622, #0d1018);
    border-radius:var(--radius); padding:28px; display:grid; place-items:center; color:var(--muted); text-align:center;
  }

  /* FAB */
  .fab{
    position:fixed; right:22px; bottom:22px; z-index:40;
    width:56px;height:56px;border-radius:16px; background:linear-gradient(180deg, var(--brand), var(--brand-600));
    border:1px solid #00000033; box-shadow: 0 10px 30px rgba(227,6,19,.45); cursor:pointer; display:grid; place-items:center;
  }
  .fab:hover{transform:translateY(-1px); background:linear-gradient(180deg, var(--brand-600), var(--brand-700))}
  .fab svg{filter: drop-shadow(0 2px 4px rgba(0,0,0,.35));}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; z-index:60; padding:20px}
  .modal.open{display:grid}
  .sheet{
    width:min(100%, 980px); max-height:90vh; overflow:hidden auto;
    background:linear-gradient(180deg, #141824, #0f1320); border:1px solid var(--stroke);
    border-radius:22px; box-shadow: var(--shadow);
  }
  .sheet .hd{
    display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--stroke);
  }
  .sheet .hd h3{margin:0; font-size:16px; letter-spacing:.2px}
  .close{background:transparent;border:1px solid var(--stroke); color:var(--muted); padding:8px 10px; border-radius:10px; cursor:pointer}
  .sheet .body{padding:16px 18px; display:flex; gap:18px; flex-direction:column}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{padding:8px 10px; border:1px solid var(--stroke); background:var(--card); color:var(--text-dim); border-radius:999px; cursor:pointer; font-size:13px}
  .tab.active{background:linear-gradient(180deg, #21273a, #191f2d); color:#fff; border-color:#00000055}
  .catalog{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px;}
  .item{
    grid-column: span 12;
    background:linear-gradient(180deg, #1a1f2c, #111522);
    border:1px solid var(--stroke); border-radius:16px; padding:12px;
    display:flex; gap:10px; align-items:center;
  }
  @media(min-width:740px){ .item{grid-column: span 6} }
  @media(min-width:980px){ .item{grid-column: span 4} }
  .item .i-thumb{width:64px;height:64px;border-radius:12px;background:#0d1020; border:1px solid var(--stroke); display:grid; place-items:center; overflow:hidden}
  .item .i-thumb img{max-width:100%; max-height:100%; object-fit:contain}
  .item .i-meta{flex:1; min-width:0}
  .item .i-title{margin:0; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .item .i-cat{font-size:12px; color:var(--muted)}
  .item .i-add{margin-left:auto}
  .step{
    display:flex; flex-direction:column; gap:12px; border:1px dashed var(--stroke); padding:12px; border-radius:14px; background:#0e1220;
  }
  .row{display:flex; flex-wrap:wrap; gap:10px}
  .field{display:flex; flex-direction:column; gap:6px; min-width:180px}
  .field input, .field select{
    background:var(--card); color:var(--text); border:1px solid var(--stroke); border-radius:10px; padding:10px 12px;
  }

  .triggers{display:flex; flex-wrap:wrap; gap:8px}
  .tg{border:1px solid var(--chip-bd); background:var(--chip); color:#cfe0ff; border-radius:12px; padding:10px; display:flex; align-items:center; gap:8px}
  .tg input[type="checkbox"]{accent-color:var(--brand); transform:scale(1.15)}
  .tg .cfg{display:flex; gap:6px; align-items:center}
  .tg .cfg input{width:92px; padding:6px 8px}
  .tg .cfg .unit{font-size:12px; color:var(--muted)}
  .footer{display:flex; justify-content:flex-end; gap:10px}

  /* Toast */
  .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#0d0f16; border:1px solid var(--stroke); color:#cfe0ff; padding:10px 14px; border-radius:12px; display:none}
  .toast.show{display:block}

  /* Import input hidden */
  #importFile{display:none}

  /* Drag handle */
  .drag{cursor:grab; opacity:.65}

  /* Tiny helper text */
  .hint{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="brand-badge"><span>GW</span></div>
    <h1>Cadastro de Itens &amp; Regras</h1>
    <div class="sub">
      <span class="pill">Tema GoodWe</span>
      <div class="actions">
        <button class="icon btn" id="exportBtn" title="Exportar JSON">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 16V3m0 0l-4 4m4-4l4 4M4 21h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Exportar
        </button>
        <label class="icon btn" for="importFile" title="Importar JSON">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 8v13m0 0l4-4m-4 4l-4-4M4 3h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Importar
        </label>
        <input id="importFile" type="file" accept=".json,application/json" />
        <button class="icon btn" id="clearBtn" title="Limpar tudo">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v12m8-12v12M5 6l1-3h12l1 3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Limpar
        </button>
      </div>
    </div>
  </header>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <input id="search" placeholder="Buscar item já adicionado…" />
    </div>
    <div class="right">
      <button class="btn brand" id="addBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px"><path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
        Adicionar item
      </button>
    </div>
  </div>

  <!-- CONTENT -->
  <main class="wrap">
    <div class="section-title">
      <h2>Itens configurados</h2>
      <span class="hint">Dica: clique e arraste pelo ícone ⠿ para reordenar. Use “Editar” para renomear, alterar quantidade e regras.</span>
    </div>
    <div id="list" class="cards"></div>
    <div id="empty" class="empty" style="display:none">
      <p>Nenhum item ainda. Clique no botão <b>Adicionar item</b> para montar sua configuração.</p>
    </div>
  </main>

  <!-- FAB -->
  <button class="fab" id="fab" title="Adicionar item">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
  </button>

  <!-- MODAL: ADICIONAR/EDITAR -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="hd">
        <h3 id="modalTitle">Adicionar item</h3>
        <button class="close" id="closeModal">Fechar</button>
      </div>
      <div class="body">
        <!-- Passo 1: catálogo -->
        <div class="step" id="step1">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div class="tabs" id="tabs"></div>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="catalogSearch" placeholder="Buscar no catálogo…" style="background:var(--card);color:var(--text); border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; min-width:240px"/>
            </div>
          </div>
          <div class="catalog" id="catalog"></div>
        </div>
        <!-- Passo 2: detalhes -->
        <div class="step" id="step2" style="display:none">
          <div class="row">
            <div class="field" style="flex:1; min-width:220px">
              <label>Nome do item</label>
              <input id="fName" placeholder="Ex.: Inversor da casa #2"/>
            </div>
            <div class="field">
              <label>Categoria</label>
              <input id="fCat" disabled />
            </div>
            <div class="field" style="max-width:160px">
              <label>Quantidade</label>
              <input id="fQty" type="number" min="1" step="1" value="1"/>
            </div>
            <div class="field" style="max-width:200px">
              <label>Lógica de ativação</label>
              <select id="fLogic">
                <option value="any">Qualquer condição</option>
                <option value="all">Todas as condições</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="field" style="flex:1">
              <label>Observações (opcional)</label>
              <input id="fNotes" placeholder="Ex.: ligado ao quadro 2 / suíte"/>
            </div>
          </div>
        </div>
        <!-- Passo 3: condições -->
        <div class="step" id="step3" style="display:none">
          <div class="triggers" id="triggerList"></div>
          <span class="hint">Você pode marcar várias condições; o item será ativado conforme a lógica escolhida acima.</span>
        </div>

        <div class="footer">
          <button class="btn" id="backBtn">Voltar</button>
          <button class="btn brand" id="saveBtn">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast">Salvo.</div>

<script>
/* ===== Imagens de exemplo (pode trocar por URLs oficiais se quiser) ===== */
const IMG = {
  inverter: 'https://en.goodwe.com/Public/Uploads/uploadfile/images/20230221/DNS.png',
  battery:  'https://en.goodwe.com/Public/Uploads/uploadfile/images/20231226/Lynx-U%E4%BA%8C%E4%BB%A3%E6%9C%BA-1.png',
  ev:       'https://en.goodwe.com/Public/Uploads/uploadfile/images/20230203/HCA-2.png',
  acc:      'https://en.goodwe.com/Public/Uploads/uploadfile/images/20230221/DNS.png'
};

/* ===== Catálogo em grupos ===== */
const CATALOG = [
  {
    cat: 'Inversores — Residenciais (on-grid)',
    key: 'inv_res',
    items: [
      'XS G3 Series', 'DNS G3 Series', 'DNS G4 Series',
      'MS G3 Series', 'MS G4 Series', 'SDT G3 Series',
      'MIS Series (Microinverter)'
    ].map(n => ({ name:n, image:IMG.inverter }))
  },
  {
    cat: 'Inversores — C&I (on-grid)',
    key: 'inv_cni',
    items: [
      'SDT G3 Series 25–40kW', 'SDT G3 Series 50kW',
      'LVSMT Series 12–35kW', 'SMT Series 25–36kW',
      'SMT Series 50–60kW', 'SMT Series 50–80kW',
      'LVMT Series 30–50kW', 'HT Series 73–120kW',
      'GT Series 100–125kW'
    ].map(n => ({ name:n, image:IMG.inverter }))
  },
  {
    cat: 'Inversores Híbridos — Residenciais (storage)',
    key: 'hyb_res',
    items: [
      'ES G2 Series (LV)', 'SBP G2 Series (LV)',
      'ES Uniq Series (LV)', 'ET PLUS+ Series 5–10kW (HV)',
      'ET Series 15–30kW (HV)', 'ET G2 Series 6–15kW (HV)',
      'ET LV Series 5–20kW (LV)', 'EH PLUS+ Series 3.6–6kW (HV)',
      'ESA Series 3–10kW / 5–48kWh (HV)'
    ].map(n => ({ name:n, image:IMG.inverter }))
  },
  {
    cat: 'Inversores Híbridos — C&I (storage)',
    key: 'hyb_cni',
    items: [
      'ET Series 40/50kW (HV)', 'STS Series (Static Transfer Switch)',
      'ETC Series 50/100kW (HV)', 'BTC Series 50/100kW (HV)',
      'ESA Series 125kW/261kWh'
    ].map(n => ({ name:n, image:IMG.inverter }))
  },
  {
    cat: 'Baterias',
    key: 'bat',
    items: [
      'Lynx A Series 5kWh (LV)', 'Lynx A G3 Series 5kWh (LV)',
      'Lynx D Series 5kWh (HV)', 'Lynx U G3 Series 5kWh (LV)',
      'Lynx F G2 Series 6.4–28.8kWh (HV)',
      'BAT Series 51.2/56.3kWh (HV)', 'BAT Series 60–112kWh (C&I)',
      'BAT Series 14.3kWh (LV)', 'Lynx C Series 60kWh (C&I)',
      'Lynx C Series 101–156kWh (HV)'
    ].map(n => ({ name:n, image:IMG.battery }))
  },
  {
    cat: 'Carregadores para VE',
    key: 'ev',
    items: [
      'HCA G2 Series AC — 7kW (monofásico)',
      'HCA G2 Series AC — 11kW (trifásico)',
      'HCA G2 Series AC — 22kW (trifásico)'
    ].map(n => ({ name:n, image:IMG.ev }))
  },
  {
    cat: 'Acessórios & Medidores',
    key: 'acc',
    items: [
      'SEMS+ (Gestão de Energia)',
      'Smart Meter GMK110 (Monofásico)',
      'Smart Meter GM330 (C&I)',
      'Smart Meter GMK330 (Residencial)',
      '4G Module KIT-EC / KIT-AU',
      '4G Kit 2.0 Smart Dongle',
      'Wi-Fi Kit 2.0 (WiFi Kit-20)',
      'Wi-Fi/LAN Kit 2.0 (WiFi/LAN Kit-20)',
      'SEC1000 / SEC1000S (Storage)',
      'SEC3000C / SEC3000',
      'EzLogger3000U / 3000U-A / 3000C',
      'RSD Receiver (Rapid Shutdown)'
    ].map(n => ({ name:n, image:IMG.acc }))
  },
  {
    cat: 'Soluções Utility (string & MV)',
    key: 'uti',
    items: [
      'HT Series 225/250kW', 'UT Series 320/350kW',
      'MV Station 3.5/5/7MVA', 'MV Station 9.152MVA'
    ].map(n => ({ name:n, image:IMG.inverter }))
  }
];

/* ===== Condições ===== */
const ALL_TRIGGERS = [
  { key:'gridOutage',       label:'Queda de energia (grid off)', type:'flag' },
  { key:'tariffRed',        label:'Bandeira tarifária vermelha', type:'flag' },
  { key:'peakHours',        label:'Horário de ponta (18:00–21:00)', type:'flag' },
  { key:'priceAbove',       label:'Preço energia >', type:'num', unit:'R$/kWh', step:'0.01' },
  { key:'batteryBelow',     label:'Bateria abaixo de', type:'num', unit:'%', min:0, max:100 },
  { key:'pvBelow',          label:'Geração solar <', type:'num', unit:'kW' },
  { key:'loadAbove',        label:'Consumo da casa >', type:'num', unit:'kW' },
  { key:'showersAtLeast',   label:'≥ chuveiros ligados', type:'num', unit:'unid', min:1, step:'1' },
  { key:'evPlugged',        label:'Carregador de VE conectado', type:'flag' },
  { key:'awayMode',         label:'Modo férias / ausente', type:'flag' },
  { key:'tempAbove',        label:'Temperatura externa >', type:'num', unit:'°C' },
];

/* ===== Estado + Persistência ===== */
const LS_KEY = 'goodwe-config-items-v1';
let items = load() || seedExamples();
let editingId = null;
let step = 1;
let selectedCatalog = null;

/* ===== Utils ===== */
function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function showToast(msg='Salvo.') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(()=> el.classList.remove('show'), 1600);
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(items)); }
function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } }
function seedExamples(){
  const ex = [
    {
      id: uid(), type: 'Inversor Híbrido', cat:'Inversores Híbridos — Residenciais (storage)',
      name:'Inversor ET PLUS+ #1', series:'ET PLUS+ Series 5–10kW (HV)', qty:1, notes:'',
      img: IMG.inverter, logic:'any',
      triggers: { gridOutage:true, tariffRed:true }
    },
    {
      id: uid(), type: 'Bateria', cat:'Baterias',
      name:'Bateria Backup', series:'Lynx U G3 Series 5kWh (LV)', qty:2, notes:'',
      img: IMG.battery, logic:'any',
      triggers: { batteryBelow:20 }
    },
    {
      id: uid(), type: 'Carregador EV', cat:'Carregadores para VE',
      name:'Carregador EV Garagem', series:'HCA G2 Series AC — 7kW (monofásico)', qty:1, notes:'',
      img: IMG.ev, logic:'any',
      triggers: { peakHours:true }
    }
  ];
  localStorage.setItem(LS_KEY, JSON.stringify(ex));
  return ex;
}

/* ===== Render lista ===== */
const listEl  = document.getElementById('list');
const emptyEl = document.getElementById('empty');

function render(){
  listEl.innerHTML = '';
  const q = (document.getElementById('search').value||'').toLowerCase();
  const data = items.filter(it =>
    `${it.name} ${it.series} ${it.cat}`.toLowerCase().includes(q)
  );
  emptyEl.style.display = data.length ? 'none' : 'grid';

  data.forEach((it) => {
    const card = document.createElement('div');
    card.className = 'card'; card.draggable = true; card.dataset.id = it.id;

    card.innerHTML = `
      <div class="drag" title="Arrastar para reordenar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 6h.01M15 6h.01M9 12h.01M15 12h.01M9 18h.01M15 18h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </div>
      <div class="thumb"><img alt="produto" src="${it.img}"/></div>
      <div class="meta">
        <p class="name">${escapeHtml(it.name)} <span class="hint">• ${escapeHtml(it.series)}</span></p>
        <div class="desc">${escapeHtml(it.cat)} • Qtde: ${it.qty} • Lógica: ${it.logic==='all'?'Todas':'Qualquer'}</div>
        <div class="chips">${renderChips(it.triggers)}</div>
      </div>
      <div class="right">
        <label class="switch" title="Ativo/Inativo">
          <input type="checkbox" ${it.enabled!==false?'checked':''} data-act="toggle" data-id="${it.id}"/>
          <span></span>
        </label>
        <div class="btns">
          <button class="btn action" data-act="dup" data-id="${it.id}" title="Duplicar">Duplicar</button>
          <button class="btn action" data-act="edit" data-id="${it.id}" title="Editar">Editar</button>
          <button class="btn action" data-act="del" data-id="${it.id}" title="Remover">Remover</button>
        </div>
      </div>
    `;

    // drag events
    card.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', it.id); });
    card.addEventListener('dragover', e => e.preventDefault());
    card.addEventListener('drop', e => {
      e.preventDefault();
      const fromId = e.dataTransfer.getData('text/plain');
      const toId = it.id;
      reorder(fromId, toId);
    });

    listEl.appendChild(card);
  });
}
function renderChips(tr){
  const entries = Object.entries(tr||{}).filter(([k,v]) => v!==false && v!==null && v!==undefined);
  if(!entries.length) return '<span class="chip">Sem condições</span>';
  return entries.map(([k,v])=>{
    const def = ALL_TRIGGERS.find(t => t.key===k);
    if(!def) return '';
    if(def.type==='flag') return `<span class="chip"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M5 5v14M5 5h9l-1 3h6" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>${def.label}</span>`;
    return `<span class="chip"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M12 6v12M6 12h12" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>${def.label} <b>${v}</b> <span class="hint">${def.unit||''}</span></span>`;
  }).join('');
}
function reorder(fromId, toId){
  const fromIdx = items.findIndex(i=>i.id===fromId);
  const toIdx   = items.findIndex(i=>i.id===toId);
  if(fromIdx<0 || toIdx<0) return;
  const [moved] = items.splice(fromIdx,1);
  items.splice(toIdx,0,moved);
  save(); render();
}

/* ===== Ações lista ===== */
listEl.addEventListener('click', e=>{
  const actBtn = e.target.closest('[data-act]');
  if(!actBtn) return;
  const id = actBtn.dataset.id;
  const act = actBtn.dataset.act;

  if(act==='del'){
    items = items.filter(i=>i.id!==id); save(); render(); showToast('Item removido.');
  }
  if(act==='dup'){
    const it = items.find(i=>i.id===id);
    if(!it) return;
    const copy = JSON.parse(JSON.stringify(it));
    copy.id = uid();
    copy.name = it.name + ' (cópia)';
    items.push(copy); save(); render(); showToast('Item duplicado.');
  }
  if(act==='edit'){
    openEdit(id);
  }
});
listEl.addEventListener('change', e=>{
  if(e.target.matches('input[type="checkbox"][data-act="toggle"]')){
    const id = e.target.dataset.id;
    const it = items.find(i=>i.id===id); if(!it) return;
    it.enabled = e.target.checked; save(); showToast(it.enabled?'Ativado':'Desativado');
  }
});

/* ===== Modal – Adicionar/Editar ===== */
const modal       = document.getElementById('modal');
const modalTitle  = document.getElementById('modalTitle');
const step1       = document.getElementById('step1');
const step2       = document.getElementById('step2');
const step3       = document.getElementById('step3');
const fName       = document.getElementById('fName');
const fCat        = document.getElementById('fCat');
const fQty        = document.getElementById('fQty');
const fLogic      = document.getElementById('fLogic');
const fNotes      = document.getElementById('fNotes');
const triggerList = document.getElementById('triggerList');

document.getElementById('addBtn').onclick = () => openAdd();
document.getElementById('fab').onclick    = () => openAdd();
document.getElementById('closeModal').onclick = closeModal;
document.getElementById('backBtn').onclick    = goBack;
document.getElementById('saveBtn').onclick    = saveModal;
document.getElementById('search').oninput     = render;

/* Catálogo tabs + busca */
const tabsEl     = document.getElementById('tabs');
const catalogEl  = document.getElementById('catalog');
const catalogSearch = document.getElementById('catalogSearch');

function openAdd(){
  /* === FIX 1: reset completo de passos ao adicionar novamente === */
  editingId = null; step = 1; selectedCatalog = null;
  modalTitle.textContent = 'Adicionar item';
  fName.value=''; fCat.value=''; fQty.value=1; fLogic.value='any'; fNotes.value='';
  step1.style.display='flex';
  step2.style.display='none';
  step3.style.display='none';
  renderTabs();
  renderCatalog();
  renderTriggers({});
  openModal();
}
function openEdit(id){
  const it = items.find(i=>i.id===id); if(!it) return;
  editingId = id; step = 2; // vai direto pros detalhes
  modalTitle.textContent = 'Editar item';
  selectedCatalog = { cat: it.cat, item: { name: it.series, image: it.img } };
  fName.value = it.name; fCat.value = it.cat; fQty.value = it.qty; fLogic.value = it.logic || 'any'; fNotes.value = it.notes || '';
  renderTriggers(it.triggers||{});
  step1.style.display='none'; step2.style.display='flex'; step3.style.display='flex';
  openModal();
}

function openModal(){ modal.classList.add('open'); }
function closeModal(){ modal.classList.remove('open'); }

function goBack(){
  if(step===1){ closeModal(); return; }
  if(step===2){ step=1; step2.style.display='none'; step3.style.display='none'; step1.style.display='flex'; return; }
  if(step===3){ step=2; step3.style.display='none'; step2.style.display='flex'; return; }
}

function renderTabs(){
  tabsEl.innerHTML = '';
  CATALOG.forEach((c, i)=>{
    const b = document.createElement('button');
    b.className = 'tab' + (i===0 ? ' active':'');
    b.textContent = c.cat; b.dataset.key = c.key;
    b.onclick = () => {
      [...tabsEl.children].forEach(ch => ch.classList.remove('active'));
      b.classList.add('active');
      renderCatalog();
    };
    tabsEl.appendChild(b);
  });
}

function activeCategory(){
  const idx = [...tabsEl.children].findIndex(ch => ch.classList.contains('active'));
  return CATALOG[idx>=0?idx:0];
}

function renderCatalog(){
  const cat = activeCategory();
  const q = (catalogSearch.value||'').toLowerCase();
  catalogEl.innerHTML = '';
  cat.items
    .filter(it => it.name.toLowerCase().includes(q))
    .forEach(it=>{
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `
        <div class="i-thumb"><img alt="" src="${it.image}"/></div>
        <div class="i-meta">
          <p class="i-title">${escapeHtml(it.name)}</p>
          <div class="i-cat">${escapeHtml(cat.cat)}</div>
        </div>
        <div class="i-add">
          <button class="btn brand">Adicionar</button>
        </div>
      `;
      el.querySelector('button').onclick = ()=>{
        selectedCatalog = { cat: cat.cat, item: it };
        // Preencher detalhes e avançar
        fCat.value = cat.cat;
        fName.value = defaultNameFrom(it.name);
        step=2;
        step1.style.display='none'; step2.style.display='flex'; step3.style.display='flex';
        renderTriggers({});
      };
      catalogEl.appendChild(el);
    });
}
catalogSearch.oninput = renderCatalog;

function defaultNameFrom(series){
  const base = series.split(' Series')[0] || series.split(' — ')[0] || series;
  const clean = base.replace(/\s+\(.+?\)/g,'').trim();
  return `${clean} #${Math.floor(Math.random()*90)+10}`;
}

/* Triggers UI */
function renderTriggers(curr){
  triggerList.innerHTML = '';
  ALL_TRIGGERS.forEach(t => {
    const row = document.createElement('label');
    row.className='tg';
    row.innerHTML = `
      <input type="checkbox" ${curr[t.key]!==undefined?'checked':''} data-k="${t.key}">
      <span>${t.label}</span>
      ${t.type==='num' ? `
        <div class="cfg" ${curr[t.key]===undefined?'style="display:none"':''}>
          <input type="number"
                 ${t.min!==undefined?`min="${t.min}"`:''}
                 ${t.max!==undefined?`max="${t.max}"`:''}
                 ${t.step?`step="${t.step}"`:''}
                 value="${typeof curr[t.key]==='number' ? curr[t.key] : ''}"
                 placeholder="valor"/>
          <span class="unit">${t.unit||''}</span>
        </div>` : ''
      }
    `;
    const cb = row.querySelector('input[type="checkbox"]');
    cb.addEventListener('change', ()=>{
      const cfg = row.querySelector('.cfg');
      if(t.type==='num') cfg.style.display = cb.checked ? 'flex' : 'none';
    });
    triggerList.appendChild(row);
  });
}

/* Salvar modal */
function saveModal(){
  if(!selectedCatalog) { showToast('Escolha um item no catálogo.'); return; }
  const name  = (fName.value||'').trim();
  const qty   = Math.max(1, parseInt(fQty.value||'1',10));
  const logic = fLogic.value==='all' ? 'all' : 'any';
  const notes = (fNotes.value||'').trim();

  const trigs = {};
  triggerList.querySelectorAll('.tg').forEach(tg=>{
    const cb = tg.querySelector('input[type="checkbox"]');
    const key = cb.dataset.k;
    if(cb.checked){
      const cfg = tg.querySelector('.cfg input');
      trigs[key] = cfg ? (cfg.value? Number(cfg.value): null) : true;
    }
  });

  if(editingId){
    const it = items.find(i=>i.id===editingId);
    Object.assign(it, {
      name: name || it.name,
      qty, logic, notes,
      triggers: trigs
    });
    save(); render(); showToast('Item atualizado.');
  }else{
    const type = deriveType(selectedCatalog.cat);
    const obj = {
      id: uid(),
      type, cat: selectedCatalog.cat,
      name: name || defaultNameFrom(selectedCatalog.item.name),
      series: selectedCatalog.item.name,
      qty, notes, logic,
      img: selectedCatalog.item.image,
      triggers: trigs,
      enabled: true
    };
    items.push(obj); save(); render(); showToast('Item adicionado.');
  }
  closeModal();
}
function deriveType(cat){
  if(cat.toLowerCase().includes('bateria')) return 'Bateria';
  if(cat.toLowerCase().includes('carregador')) return 'Carregador EV';
  if(cat.toLowerCase().includes('acess')) return 'Acessório';
  if(cat.toLowerCase().includes('utility')) return 'Utility';
  if(cat.toLowerCase().includes('híbrid')) return 'Inversor Híbrido';
  return 'Inversor';
}

/* Exportar / Importar / Limpar */
document.getElementById('exportBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'goodwe-config.json';
  a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('importFile').onchange = e=>{
  const file = e.target.files[0]; if(!file) return;
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const data = JSON.parse(fr.result);
      if(!Array.isArray(data)) throw new Error('Formato inválido');
      items = data; save(); render(); showToast('Importado.');
    }catch(err){
      alert('Falha ao importar: ' + err.message);
    }
  };
  fr.readAsText(file);
  e.target.value='';
};
document.getElementById('clearBtn').onclick = ()=>{
  if(confirm('Tem certeza que deseja remover todos os itens?')){
    items = []; save(); render(); showToast('Tudo limpo.');
  }
};

/* Helpers */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

/* Inicialização */
render();
</script>
</body>
</html>